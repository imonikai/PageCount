<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>枚数換算するやつ</title>
</head>
<style>
    body {
        background-color:#fbfaf5;
        margin: 2em;
        text-align: center;
    }
    textarea {
        margin: 2em;
        margin-top: 0;
        margin-bottom: 0;
        width: 60%;
        height: 20em;
    }
    p {
        margin: 0.5em;
    }

    .input {
        margin: 1em;
    }

    #copyright {
        margin-top: 2em;
    }
</style>
<body>
    <h1>枚数換算するやつ</h1>
    <p>これは、指定された文章を、指定された原稿設定に基づいて枚数換算するやつです。</br>
    小説新人賞のやつとかにご利用ください。</p>
    <p>入力された情報はブラウザ上のみで処理され、外部に送信することはありません。</p>
    <details>
        <summary>細かい仕様はこちら</summary>
            <p>１行の文字数に満たない行でも改行があれば１行分カウントします。</p>
            <p>改行のみの行も１行と判定します。</p>
            <p>禁則処理を考慮しません。</p>
    </details>
    <a href="https://github.com/imonikai/PageCount" >ソースコードはこちら。連絡がある場合もこちら。</a>
    <p><strong>自己責任でご利用ください。いかなるトラブル、損失について作者は一切責任を負いません。</strong></p>
    <div class="input">
        <label for="lineCharNum">１行の文字数</label>
        <input type="number" id="lineCharNum" value="40" min="1">
        <label for="lineNum">１ページの行数</label>
        <input type="number" id="lineNum" value="32" min="1">
    </div>
    <div class="input">
        <input type="file" id="fileInput" accept=".txt">
        <label for="charcode">ファイルの文字コード</label>
        <select id="charcode" required>
            <option value="utf-8">UTF-8</option>
            <option value="shift-jis">Shift-JIS</option>
            <option value="euc-jp">EUC-JP</option>
        </select>
    </div>
    <textarea id="text"></textarea>
    <div class="input">
        <input type="button" id="calcButton" value="換算">
    </div>
    <div>
        <div>文字数　: <span id="charCount"></span></div>
        <div>行数　　: <span id="lineCount"></span></div>
        <div>ページ数: <span id="pageCount"></span></div>
    </div>
    <p id="copyright">© 2023 imonikai</p>
</body>

<script>
    const fileInputObj = document.getElementById('fileInput');
    const charcodeObj = document.getElementById('charcode');
    const textObj = document.getElementById('text');
    const lineCharNumObj = document.getElementById('lineCharNum');
    const lineNumObj = document.getElementById('lineNum');
    const charCountObj = document.getElementById('charCount');
    const lineCountObj = document.getElementById('lineCount');
    const pageCountObj = document.getElementById('pageCount');
    let file = null;
    let charCount = 0;
    let lineCount = 0;
    let pageCount = 0;

    function clearResult() {
        charCountObj.innerText = '';
        lineCountObj.innerText = '';
        pageCountObj.innerText = '';
    }

    function calc(str, lineCharNum, lineNum) {
        const strArray = str.split(/\r\n|\n/);
        charCount = 0;
        lineCount = 0;
        pageCount = 0;

        for( let i = 0; i < strArray.length; i++ ) {
            //文字数カウント
            charCount += strArray[i].length;

            //改行のみの行は１行カウント
            if(strArray[i] == '')
                lineCount++;
            //１段落の文字数を１行分の文字数で割った数（行数）を加算
            else
                lineCount += Math.ceil(strArray[i].length / lineCharNum);
        }
        pageCount += Math.ceil(lineCount / lineNum);

        return pageCount;
    }

    function loadFile()
    {
        if(file === null)
            return ;

        const reader = new FileReader();
        reader.readAsText(file, charcodeObj.value);

        reader.onload = () => {
            textObj.value = reader.result;
            clearResult();
        }

        reader.onerror = () => {
            alert('ファイルの読み込みに失敗しました。');
        }
    }

    function process() {
        const lineCharNum = parseInt(lineCharNumObj.value);
        const lineNum     = parseInt(lineNumObj.value);

        if( isNaN(lineCharNum) || isNaN(lineNum) || lineCharNum <= 0 || lineNum <= 0 ) {
            alert('文字数と行数を正の整数に設定してください。');
            return;
        }

        calc(textObj.value, lineCharNum, lineNum);

        charCountObj.innerText = String(charCount);
        lineCountObj.innerText = String(lineCount);
        pageCountObj.innerText = String(pageCount);
    }

    /* テキストエリアか設定が変更されたときは前の計算の結果を消す */
    textObj.addEventListener('change', clearResult);
    lineCharNumObj.addEventListener('change', clearResult);
    lineNumObj.addEventListener('change', clearResult);

    /* ファイルを読み込んだときはテキストエリアにファイルの内容を書き込み、前の計算の結果を消す */
    fileInputObj.addEventListener('change', function(e) {
        file = e.target.files[0];
        loadFile();
        clearResult();
    });

    /* */
    charcodeObj.addEventListener('change', function(){
        loadFile();
        clearResult();
    });

    /* 換算ボタンが押されたときに計算する */
    document.getElementById('calcButton').addEventListener('click', function(){
        process();
    });

</script>
</html>
